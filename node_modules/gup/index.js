#!/usr/bin/env node

const math = require('mathjs')
const http = require('http')

function getStockPrice () {
  return new Promise(function (resolve, reject) {
    http.get('http://hq.sinajs.cn/list=gb_baba', (res) => {
      let rawData = ''
      res.on('data', (chunk) => { rawData += chunk })
      res.on('end', () => {
        try {
          resolve(rawData.split(',')[1])
        } catch (e) {
          console.error(e.message)
        }
      })
    })
  })
}

function getExchangeRate () {
  return new Promise(function (resolve, reject) {
    http.get('http://hq.sinajs.cn/list=USDCNY', (res) => {
      let rawData = ''
      res.on('data', (chunk) => { rawData += chunk })
      res.on('end', () => {
        try {
          resolve(rawData.split(',')[1])
        } catch (e) {
          console.error(e.message)
        }
      })
    })
  })
}

function numberFormat (value) {
  var param = {}
  var k = 10000
  var sizes = ['', '万', '亿', '万亿']

  var i
  if (value < k) {
    param.value = ('0.' + value).split('').slice(0, 4).join('')
    param.unit = '万'
  } else {
    i = Math.floor(Math.log(value) / Math.log(k))

    param.value = ((value / Math.pow(k, i))).toFixed(2)
    param.unit = sizes[i]
  }
  return param
}

function main () {
  return Promise.all([getStockPrice(), getExchangeRate()]).then(function (result) {
    console.log('公式：money = 股价 * 汇率 * 个税 * 数量')
    console.log('股价：' + result[0])
    console.log('汇率：' + result[1])
    console.log('个税：0.45')

    var argv = process.argv
    argv.shift()

    if (parseInt(argv[1]) > 0) {
      const count = parseInt(argv[1])
      console.log('数量：' + count)
      const money = math.evaluate(`${result[0]} * ${result[1]} * 0.45 * ${count}`)
      const arr = numberFormat(money)
      console.log('最终到手：' + arr.value + '' + arr.unit)
    }
  })
}

main()
